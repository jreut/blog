#!/usr/bin/env node

const fs = require('fs')
const path = require('path')
const mustache = require('mustache')
const tocTask = require('../lib/toc')

const src = 'src'
const dist = 'dist'

const indexTemplate = path.join(src, 'index.mustache')
const indexDist = path.join(dist, 'index.html')
const entryTemplate = path.join(src, 'entry.mustache')
const entryDist = path.join(dist, 'entries')

const readFile = function (file) {
  return fs.readFileSync(file, { encoding: 'utf-8' })
}

tocTask().map(function (toc) {
  const templateString = readFile(indexTemplate)
  fs.writeFileSync(indexDist, mustache.render(templateString, toc))

  const entryTemplateString = readFile(entryTemplate)
  toc.entries.forEach(function (entry) {
    const file = entry.src
    const partial = readFile(file)
    const outputFile = path.join(entryDist, path.basename(file))

    fs.writeFileSync(outputFile, mustache.render(
      entryTemplateString,
      { title: entry.name },
      { entry: partial })
    )
  })
}).run()
